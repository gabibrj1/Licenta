<div class="local-vote">
  <h2>Vot Local</h2>
  
  <div *ngIf="isLoading" class="loading">
    <p>Se încarcă...</p>
  </div>
  
  <div *ngIf="error" class="error">
    <p>{{ error }}</p>
  </div>
  
  <!-- Pasul 1: Verificare eligibilitate -->
  <div *ngIf="currentStep === 1" class="vote-container">
    <h3>Verificare eligibilitate</h3>
    
    <div *ngIf="!isEligible && authType === 'email'" class="auth-warning">
      <p>Pentru a participa la votul local, trebuie să vă autentificați folosind buletinul.</p>
      <p>Această metodă de vot necesită verificarea identității prin buletin pentru a vă confirma eligibilitatea pentru votul local.</p>
      <button class="btn-primary" (click)="redirectToIDRegistration()">Înregistrare cu buletin</button>
    </div>
  </div>
  
  <!-- Pasul 2: Confirmare adresă -->
  <div *ngIf="currentStep === 2" class="vote-container">
    <h3>Confirmarea adresei</h3>
    
    <div class="user-info">
      <p><strong>CNP:</strong> {{ userInfo.cnp }}</p>
      <p><strong>Nume:</strong> {{ userInfo.last_name }} {{ userInfo.first_name }}</p>
    </div>
    
    <p>Pentru a identifica secția de vot, vă rugăm să confirmați adresa dumneavoastră:</p>
    
    <form [formGroup]="addressForm" (ngSubmit)="submitAddress()">
      <div class="form-group">
        <label for="county">Județ (Cod 2 litere)</label>
        <input type="text" id="county" formControlName="county" class="form-control" placeholder="Cod județ (ex: {{ getRandomCountyExample() }})" maxlength="2">
        <div *ngIf="addressForm.get('county')?.errors?.['required'] && addressForm.get('county')?.touched" class="error-text">
          Județul este obligatoriu
        </div>
        <div *ngIf="addressForm.get('county')?.errors?.['maxlength'] && addressForm.get('county')?.touched" class="error-text">
          Codul județului trebuie să aibă maximum 2 caractere
        </div>
        <div *ngIf="addressForm.get('county')?.errors?.['invalidCounty'] && addressForm.get('county')?.touched" class="error-text">
          Codul județului trebuie să conțină doar litere mari (ex: B, CJ, IS, CT)
        </div>
        <div class="hint-text">
          Exemple: B (București), CJ (Cluj), IS (Iași), CT (Constanța), TM (Timiș), BV (Brașov)
        </div>
      </div>
      
      <div class="form-group">
        <label for="city">Localitate</label>
        <input type="text" id="city" formControlName="city" class="form-control" placeholder="LOCALITATEA">
        <div *ngIf="addressForm.get('city')?.errors?.['required'] && addressForm.get('city')?.touched" class="error-text">
          Localitatea este obligatorie
        </div>
      </div>
      
      <div class="form-group">
        <label for="address">Adresă completă</label>
        <input type="text" id="address" formControlName="address" class="form-control" 
               placeholder="Introduceți adresa completă, fără prescurtări">
        <div *ngIf="addressForm.get('address')?.errors?.['required'] && addressForm.get('address')?.touched" class="error-text">
          Adresa este obligatorie
        </div>
        <div *ngIf="addressForm.get('address')?.errors?.['abbreviationsNotAllowed'] && addressForm.get('address')?.touched" class="error-text">
          Vă rugăm să evitați prescurtările (str, nr, bl, sc, ap, et). Scrieți adresa completă.
        </div>
      </div>
      
      <button type="submit" class="btn-primary" [disabled]="addressForm.invalid">Identifică secția de vot</button>
    </form>
  </div>

  <!-- Pasul 3A: Alegere între multiple secții de vot -->
<div *ngIf="currentStep === 3 && showMultipleSections" class="vote-container">
  <h3>Selectați secția de vot</h3>
  
  <div class="multiple-sections-info">
    <p>Am găsit mai multe secții de votare pentru {{ streetName }}.</p>
    <p>Vă rugăm să selectați secția care corespunde adresei dumneavoastră:</p>
  </div>
  
  <div class="sections-list">
    <div *ngFor="let section of multipleSections" class="section-option">
      <div class="section-details">
        <h4>{{ section.name }}</h4>
        <p><strong>Secția:</strong> {{ section.section_id }}</p>
        <p><strong>Adresă:</strong> {{ section.address }}</p>
        <p *ngIf="section.address_desc"><strong>Adresă detaliată:</strong> {{ section.address_desc }}</p>
        <p *ngIf="section.locality"><strong>Localitate componentă:</strong> {{ section.locality }}</p>
        <p *ngIf="section.street"><strong>Arteră:</strong> {{ section.street }}</p>
      </div>
      <button class="btn-primary" (click)="selectSection(section.index)">Selectează această secție</button>
    </div>
  </div>
  
  <div class="button-group">
    <button class="btn-secondary" (click)="backToAddressForm()">Înapoi la adresă</button>
  </div>
</div>
  
<!-- Pasul 3B: Afișare secție de vot -->
<div *ngIf="currentStep === 3 && !showMultipleSections && votingSection" class="vote-container">
  <h3>Secția de vot</h3>
  
  <div class="voting-section">
    <p>Pe baza adresei furnizate, secția dumneavoastră de vot este:</p>
    <div class="section-details">
      <p><strong>Secția:</strong> {{ votingSection.section_id }}</p>
      <p><strong>Nume:</strong> {{ votingSection.name }}</p>
      <p><strong>Adresă:</strong> {{ votingSection.address }}</p>
      <p *ngIf="votingSection.address_desc"><strong>Adresă detaliată:</strong> {{ votingSection.address_desc }}</p>
      <p><strong>Localitate:</strong> {{ votingSection.city }}</p>
      <p><strong>Județ:</strong> {{ votingSection.county }}</p>
      <p *ngIf="votingSection.locality"><strong>Localitate componentă/Sat aparținător:</strong> {{ votingSection.locality }}</p>
      
      <!-- Informații despre strada potrivită dacă există -->
      <p *ngIf="matchedStreet" class="matched-street">
        <strong>Strada identificată:</strong> {{ matchedStreet }}
      </p>
      
      <!-- Informații despre metoda de identificare -->
      <p *ngIf="method" class="identification-method">
        <small>Identificat prin: {{ getMethodName(method) }}</small>
      </p>
    </div>
  </div>
  
  <p>Vă rugăm să confirmați că aceasta este secția de vot corectă pentru a continua.</p>
  
  <div class="button-group">
    <button class="btn-secondary" (click)="currentStep = 2">Modifică adresa</button>
    <button class="btn-primary" (click)="confirmVotingSection()">Confirmă secția de vot</button>
  </div>
</div>
  
  <!-- Pasul 4: Buletinul de vot -->
  <div *ngIf="currentStep === 4" class="vote-container">
    <h3>Buletinul de vot local</h3>
    
    <div *ngIf="candidates" class="ballot">
      <div *ngFor="let positionKey of objectKeys(candidates)" class="position-section">
        <h4>{{ getPositionLabel(positionKey) }}</h4>
        <div class="candidates-grid">
          <div *ngFor="let candidate of candidates[positionKey]" 
               class="candidate-card" 
               [class.selected]="selectedCandidates[positionKey] === candidate.id"
               (click)="selectCandidate(positionKey, candidate.id)">
            <div class="candidate-photo">
              <img *ngIf="candidate.photo_url" [src]="candidate.photo_url" alt="{{ candidate.name }}">
              <div *ngIf="!candidate.photo_url" class="no-photo">
                <i class="fas fa-user"></i>
              </div>
            </div>
            <div class="candidate-info">
              <p class="candidate-name">{{ candidate.name }}</p>
              <p class="candidate-party">{{ candidate.party }}</p>
              <div class="vote-checkbox">
                <i class="fas" [ngClass]="{'fa-check-circle': selectedCandidates[positionKey] === candidate.id, 'fa-circle': selectedCandidates[positionKey] !== candidate.id}"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="submit-vote">
        <button class="btn-primary" (click)="submitVote()" [disabled]="objectKeys(selectedCandidates).length === 0">
          Finalizează votul
        </button>
      </div>
    </div>
  </div>
</div>