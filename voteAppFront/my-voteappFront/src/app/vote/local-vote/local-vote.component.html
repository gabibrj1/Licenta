<div class="local-vote">
  <h2>Vot Local</h2>
  
  <div *ngIf="isLoading" class="loading">
    <p>Se încarcă...</p>
  </div>
  
  <div *ngIf="error" class="error">
    <p>{{ error }}</p>
  </div>
  
  <!-- Pasul 1: Verificare eligibilitate -->
  <div *ngIf="currentStep === 1" class="vote-container">
    <h3>Verificare eligibilitate</h3>
    
    <div *ngIf="!isEligible && authType === 'email'" class="auth-warning">
      <p>Pentru a participa la votul local, trebuie să vă autentificați folosind buletinul.</p>
      <p>Această metodă de vot necesită verificarea identității prin buletin pentru a vă confirma eligibilitatea pentru votul local.</p>
      <button class="btn-primary" (click)="redirectToIDRegistration()">Înregistrare cu buletin</button>
    </div>
  </div>
  
  <!-- Pasul 2: Confirmare adresă -->
  <div *ngIf="currentStep === 2" class="vote-container">
    <h3>Confirmarea adresei</h3>
    
    <div class="user-info">
      <p><strong>CNP:</strong> {{ userInfo.cnp }}</p>
      <p><strong>Nume:</strong> {{ userInfo.last_name }} {{ userInfo.first_name }}</p>
    </div>
    
    <p>Pentru a identifica secția de vot, vă rugăm să confirmați adresa dumneavoastră:</p>
    
    <form [formGroup]="addressForm" (ngSubmit)="submitAddress()">
      <div class="form-group">
        <label for="county">Județ (Cod 2 litere)</label>
        <input type="text" id="county" formControlName="county" class="form-control" placeholder="Cod județ (ex: {{ getRandomCountyExample() }})" maxlength="2">
        <div *ngIf="addressForm.get('county')?.errors?.['required'] && addressForm.get('county')?.touched" class="error-text">
          Județul este obligatoriu
        </div>
        <div *ngIf="addressForm.get('county')?.errors?.['maxlength'] && addressForm.get('county')?.touched" class="error-text">
          Codul județului trebuie să aibă maximum 2 caractere
        </div>
        <div *ngIf="addressForm.get('county')?.errors?.['invalidCounty'] && addressForm.get('county')?.touched" class="error-text">
          Codul județului trebuie să conțină doar litere mari (ex: B, CJ, IS, CT)
        </div>
        <div class="hint-text">
          Exemple: B (București), CJ (Cluj), IS (Iași), CT (Constanța), TM (Timiș), BV (Brașov)
        </div>
      </div>
      
      <div class="form-group">
        <label for="city">Localitate</label>
        <input type="text" id="city" formControlName="city" class="form-control" placeholder="LOCALITATEA">
        <div *ngIf="addressForm.get('city')?.errors?.['required'] && addressForm.get('city')?.touched" class="error-text">
          Localitatea este obligatorie
        </div>
      </div>
      
      <div class="form-group">
        <label for="address">Adresă completă</label>
        <input type="text" id="address" formControlName="address" class="form-control" 
               placeholder="Introduceți adresa completă, fără prescurtări">
        <div *ngIf="addressForm.get('address')?.errors?.['required'] && addressForm.get('address')?.touched" class="error-text">
          Adresa este obligatorie
        </div>
        <div *ngIf="addressForm.get('address')?.errors?.['abbreviationsNotAllowed'] && addressForm.get('address')?.touched" class="error-text">
          Vă rugăm să evitați prescurtările (str, nr, bl, sc, ap, et). Scrieți adresa completă.
        </div>
      </div>
      
      <button type="submit" class="btn-primary" [disabled]="addressForm.invalid">Identifică secția de vot</button>
    </form>
  </div>

  <!-- Pasul 3A: Alegere între multiple secții de vot -->
  <div *ngIf="currentStep === 3 && showMultipleSections" class="vote-container">
    <h3>Selectați secția de vot</h3>
    
    <div class="multiple-sections-info">
      <p>Am găsit mai multe secții de votare pentru {{ streetName }}.</p>
      <p>Vă rugăm să selectați secția care corespunde adresei dumneavoastră:</p>
    </div>
    
    <div class="sections-list">
      <div *ngFor="let section of multipleSections" class="section-option">
        <div class="section-details">
          <h4>{{ section.name }}</h4>
          <p><strong>Secția:</strong> {{ section.section_id }}</p>
          <p><strong>Adresă:</strong> {{ section.address }}</p>
          <p *ngIf="section.address_desc"><strong>Adresă detaliată:</strong> {{ section.address_desc }}</p>
          <p *ngIf="section.locality"><strong>Localitate componentă:</strong> {{ section.locality }}</p>
          <p *ngIf="section.street"><strong>Arteră:</strong> {{ section.street }}</p>
        </div>
        <button class="btn-primary" (click)="selectSection(section.index)">Selectează această secție</button>
      </div>
    </div>
    
    <div class="button-group">
      <button class="btn-secondary" (click)="backToAddressForm()">Înapoi la adresă</button>
    </div>
  </div>
  
  <!-- Pasul 3B: Afișare secție de vot -->
  <div *ngIf="currentStep === 3 && !showMultipleSections && votingSection" class="vote-container">
    <h3>Secția de vot</h3>
    
    <div class="voting-section">
      <p>Pe baza adresei furnizate, secția dumneavoastră de vot este:</p>
      <div class="section-details">
        <p><strong>Secția:</strong> {{ votingSection.section_id }}</p>
        <p><strong>Nume:</strong> {{ votingSection.name }}</p>
        <p><strong>Adresă:</strong> {{ votingSection.address }}</p>
        <p *ngIf="votingSection.address_desc"><strong>Adresă detaliată:</strong> {{ votingSection.address_desc }}</p>
        <p><strong>Localitate:</strong> {{ votingSection.city }}</p>
        <p><strong>Județ:</strong> {{ votingSection.county }}</p>
        <p *ngIf="votingSection.locality"><strong>Localitate componentă/Sat aparținător:</strong> {{ votingSection.locality }}</p>
        
        <!-- Informații despre strada potrivită dacă există -->
        <p *ngIf="matchedStreet" class="matched-street">
          <strong>Strada identificată:</strong> {{ matchedStreet }}
        </p>
        
        <!-- Informații despre metoda de identificare -->
        <p *ngIf="method" class="identification-method">
          <small>Identificat prin: {{ getMethodName(method) }}</small>
        </p>
      </div>
    </div>
    
    <p>Vă rugăm să confirmați că aceasta este secția de vot corectă pentru a continua.</p>
    
    <div class="button-group">
      <button class="btn-secondary" (click)="currentStep = 2">Modifică adresa</button>
      <button class="btn-primary" (click)="confirmVotingSection()">Confirmă secția de vot</button>
    </div>
  </div>

<!-- Avertisment de monitorizare video -->
<div *ngIf="showMonitoringWarning" class="monitoring-warning-overlay">
  <div class="monitoring-warning-box">
    <div class="warning-header">
      <i class="fas fa-video"></i>
      <h3>Avertisment: Monitorizare video</h3>
    </div>
    
    <div class="warning-content">
      <p class="intro-text">Pentru securitatea procesului de vot, acest modul va utiliza camera pentru:</p>
      <ul>
        <li><i class="fas fa-id-card"></i> Verificarea continuă a identității dvs. (comparare cu imaginea buletinului)</li>
        <li><i class="fas fa-users"></i> Detectarea prezenței mai multor persoane</li>
        <li><i class="fas fa-shield-alt"></i> Prevenirea fraudei și a tentativelor de spoofing</li>
      </ul>
      
      <div class="lighting-notice">
        <i class="fas fa-lightbulb pulse-icon"></i>
        <p>Pentru o detectare optimă, asigurați-vă că vă aflați într-un spațiu cu lumină neutră. Lumina prea puternică sau prea slabă poate afecta acuratețea detecției, deoarece modelul de recunoaștere facială este sensibil la condițiile de iluminare.</p>
      </div>
      
      <div class="privacy-notice">
        <p><i class="fas fa-lock"></i> Imaginile sunt procesate doar local și nu sunt stocate.</p>
      </div>
      
      <p class="warning-text">
        <i class="fas fa-exclamation-triangle"></i> Dacă sunt detectate încălcări de securitate (persoane multiple, identitate neconfirmată), procesul de vot va fi întrerupt automat.
      </p>
    </div>
    
    <div class="button-group">
      <button class="btn-secondary btn-refuse" (click)="refuseMonitoring()">
        <i class="fas fa-times-circle"></i> Refuz (Ieșire)
      </button>
      <button class="btn-primary btn-accept" (click)="acceptMonitoring()">
        <i class="fas fa-check-circle"></i> Accept monitorizarea
      </button>
    </div>
  </div>
</div>
  
  <!-- Pasul 4: Buletinul de vot -->
  <div *ngIf="currentStep === 4" class="vote-container">
    <h3>Buletinul de vot local</h3>

      <!-- Timer-ul de vot -->
  <div class="vote-timer" [ngClass]="{'timer-warning': isTimerWarning, 'timer-danger': isTimerDanger, 'timer-flash': isTimerFlashing}">
    <i class="fas fa-clock"></i>
    <span>Timp rămas: {{ formattedTimeRemaining }}</span>
  </div>
  
  <!-- Alerte timer -->
  <div *ngIf="showTimerAlert" class="timer-alert">
    <i class="fas fa-exclamation-triangle"></i>
    <span>{{ timerAlertMessage }}</span>
  </div>
    
    <!-- Adaugă un mesaj de debug -->
    <div *ngIf="!candidates || objectKeys(candidates).length === 0" class="error-text">
      Nu există candidați pentru această localitate sau datele nu au fost încărcate corect.
      <pre>{{ error }}</pre>
    </div>
    
    <div class="voting-layout">
      <!-- Zona de buletin de vot -->
      <div class="ballot-container">
        <div *ngIf="candidates && objectKeys(candidates).length > 0" class="ballot">
          <div *ngFor="let positionKey of objectKeys(candidates)" class="position-section">
            <h4>{{ getPositionLabel(positionKey) }}</h4>
            <p>Candidați: {{ candidates[positionKey].length }}</p>
            <div class="candidates-grid">
              <div *ngFor="let candidate of candidates[positionKey]" 
                  class="candidate-card" 
                  [class.selected]="selectedCandidates[positionKey] === candidate.id"
                  (click)="selectCandidate(positionKey, candidate.id)">
                <div class="candidate-photo">
                  <img *ngIf="candidate.photo_url" [src]="candidate.photo_url" alt="{{ candidate.name }}">
                  <div *ngIf="!candidate.photo_url" class="no-photo">
                    <i class="fas fa-user"></i>
                  </div>
                </div>
                <div class="candidate-info">
                  <p class="candidate-name">{{ candidate.name }}</p>
                  <p class="candidate-party">{{ candidate.party }}</p>
                  <div class="vote-checkbox">
                    <i class="fas" [ngClass]="{'fa-check-circle': selectedCandidates[positionKey] === candidate.id, 'fa-circle': selectedCandidates[positionKey] !== candidate.id}"></i>
                  </div>
                </div>

                <div class="vote-stamp" *ngIf="selectedCandidates[positionKey] === candidate.id">
                  <svg viewBox="0 0 100 100" class="stamp-svg">
                    <circle cx="50" cy="50" r="45" class="stamp-circle" />
                    <text x="50" y="55" text-anchor="middle" class="stamp-text">VOTAT</text>
                  </svg>
                </div>

              </div>
            </div>
          </div>
          
          <div class="submit-vote">
            <button class="btn-primary" (click)="submitVote()" [disabled]="objectKeys(selectedCandidates).length === 0">
              Finalizează votul
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Componenta de monitorizare video - un singur element, nu duplicat -->
  <div *ngIf="isMonitoringActive" class="video-monitoring-container">
    <div class="video-wrapper">
      <video #videoElement autoplay playsinline [class.blurred]="showSecurityAlert"></video>
      
      <div *ngIf="faceDetected && !showSecurityAlert" 
          class="face-box" 
          [ngClass]="faceBoxClass"
          [ngStyle]="{'top.px': faceBox?.top, 'left.px': faceBox?.left, 'width.px': faceBox?.width, 'height.px': faceBox?.height}">
      </div>
      
      <div class="face-status-message" [ngClass]="faceBoxClass">
        {{ faceMatchMessage }}
      </div>
    </div>
    
    <div *ngIf="showSecurityAlert" class="security-alert">
      <i class="fas fa-exclamation-triangle"></i>
      <h4>Alertă de securitate</h4>
      <p>S-a detectat o potențială încălcare a procesului de vot.</p>
      <p>{{ faceMatchMessage }}</p>
    </div>
  </div>
</div>
<!-- Dialog de confirmare vot -->
<div *ngIf="showConfirmDialog" class="confirm-vote-overlay">
  <div class="confirm-vote-dialog">
    <div class="dialog-header">
      <h3>Confirmați votul dumneavoastră</h3>
    </div>
    
    <div class="dialog-content">
      <p>Sunteți pe cale să votați pentru:</p>
      
      <div class="vote-summary">
        <div *ngFor="let candidate of candidatesForConfirmation" class="candidate-summary">
          <p><strong>{{ candidate.position }}:</strong> {{ candidate.name }} ({{ candidate.party }})</p>
        </div>
      </div>
      
      <p>Secția de votare: {{ votingSection?.name }} ({{ votingSection?.section_id }})</p>
      
      <!-- Mesaj de eroare dacă există -->
      <div *ngIf="error" class="error-message">
        <p>{{ error }}</p>
      </div>
      
      <div class="receipt-options">
        <div class="form-check">
          <input type="checkbox" id="sendReceiptEmail" [(ngModel)]="sendReceiptEmail" class="form-check-input">
          <label for="sendReceiptEmail" class="form-check-label">
            Doresc să primesc o confirmare cu detaliile votului
          </label>
        </div>
        
        <div *ngIf="sendReceiptEmail" class="receipt-method mt-2">
          <div class="receipt-type">
            <div class="form-check">
              <input type="radio" id="receiptEmail" name="receiptMethod" value="email" 
                    [(ngModel)]="receiptMethod" class="form-check-input" 
                    (change)="updateReceiptMethod('email')">
              <label for="receiptEmail" class="form-check-label">
                Prin email
              </label>
            </div>
            
            <div class="form-check disabled">
              <input type="radio" id="receiptSMS" name="receiptMethod" value="sms" 
                    [(ngModel)]="receiptMethod" class="form-check-input" 
                    (change)="updateReceiptMethod('sms')" [disabled]="true">
              <label for="receiptSMS" class="form-check-label text-muted">
                Prin SMS (indisponibil momentan)
              </label>
            </div>
          </div>
          
          <div class="contact-info-input">
            <input type="text" 
                   [placeholder]="receiptMethod === 'email' ? 'Introduceți adresa de email' : 'Introduceți numărul de telefon'" 
                   [(ngModel)]="contactInfo" 
                   (input)="validateContactInfo()"
                   class="form-control"
                   [ngClass]="{'is-invalid': !isContactInfoValid && contactInfo}">
          </div>
        </div>
      </div>
    </div>
    
    <div class="dialog-footer">
      <button class="btn-secondary" (click)="cancelConfirmation()" [disabled]="confirmationInProgress">
        Anulează
      </button>
      <button class="btn-primary" (click)="confirmFinalVote()" [disabled]="confirmationInProgress || (sendReceiptEmail && !isContactInfoValid && contactInfo)">
        <span *ngIf="confirmationInProgress">
          <i class="fas fa-spinner fa-spin"></i> Se procesează...
        </span>
        <span *ngIf="!confirmationInProgress">Confirm votul</span>
      </button>
    </div>
  </div>
</div>